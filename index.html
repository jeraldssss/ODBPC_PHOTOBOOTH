<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Our Daily Bread Presbyterian Church Photobooth</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header>
<div class="brand">Our Daily Bread Presbyterian Church Photobooth</div>
<div class="subtitle">Minimal • Black & White • Friendly</div>
</header>

<main>
<section class="panel" aria-labelledby="chooseLayoutTitle">
<h3 id="chooseLayoutTitle">Choose a layout</h3>
<p class="small">Pick how many photos will appear in the final strip/collage. After choosing, press <strong>Start</strong> to enable the camera.</p>

<div class="layouts" id="layouts"></div>

<div style="margin-top:14px;display:flex;gap:8px;justify-content:space-between;align-items:center">
<div class="small">Selected: <span id="selectedCount">—</span></div>
<div>
<button class="btn" id="btnStart">Start</button>
</div>
</div>

<hr style="margin:16px 0;border:none;border-top:1px solid rgba(0,0,0,0.04)">

<div style="display:flex;flex-direction:column;gap:8px">
<label class="small">Timer setting</label>
<select id="timerSelect" class="ghost" style="padding:8px 10px">
<option value="3">3 seconds</option>
<option value="5">5 seconds</option>
<option value="10">10 seconds</option>
<option value="15">15 seconds</option>
</select>

<div style="display:flex;gap:8px;align-items:center;margin-top:10px">
<button class="ghost" id="btnSequence">Start Sequence</button>
<div class="small">(Will capture <span id="seqCount">0</span> photos consecutively)</div>
</div>

<div style="margin-top:8px;font-size:0.9rem;color:var(--muted)">Tips: Use <strong>Capture</strong> for single shots. Use <strong>Start Sequence</strong> to take N photos back-to-back using the selected timer.</div>
</div>
</section>

<section class="capture">
<div class="stage" id="stage">
<div class="camera-container" id="cameraContainer">
<video id="camera" autoplay playsinline muted></video>
<div id="countdown" aria-live="polite"></div>
<img id="previewThumb" alt="preview" style="display:none" />
</div>

<div class="controls">
<button class="btn" id="btnCapture">Capture</button>
<button class="ghost" id="btnFullscreen">Camera Fullscreen</button>
<button class="ghost" id="btnReset">Reset</button>
<button class="ghost" id="btnDownload" style="display:none">Download Collage</button>
</div>

<div class="collage" id="collagePreview" aria-live="polite" style="width:100%"></div>
</div>
</section>
</main>

<footer>Built for Our Daily Bread Presbyterian Church • Cute & Minimal</footer>

<script>
// Photobooth name
const PHOTOSTRIP_NAME = "Our Daily Bread Presbyterian Church";

// configuration
const LAYOUT_OPTIONS = [2,3,4,6];

// state
let chosen = null;
let captures = []; 
let cameraStream = null;
let countdownTimer = null;

// DOM refs
const layoutsEl = document.getElementById('layouts');
const selectedCountEl = document.getElementById('selectedCount');
const btnStart = document.getElementById('btnStart');
const timerSelect = document.getElementById('timerSelect');
const btnSequence = document.getElementById('btnSequence');
const seqCountEl = document.getElementById('seqCount');

const camera = document.getElementById('camera');
const cameraContainer = document.getElementById('cameraContainer');
const btnCapture = document.getElementById('btnCapture');
const btnFullscreen = document.getElementById('btnFullscreen');
const btnReset = document.getElementById('btnReset');
const countdownEl = document.getElementById('countdown');
const previewThumb = document.getElementById('previewThumb');
const collagePreview = document.getElementById('collagePreview');
const btnDownload = document.getElementById('btnDownload');

// build layout tiles
function createLayoutTile(n){
  const t = document.createElement('div');
  t.className = 'layout-tile';
  t.tabIndex = 0;
  const title = document.createElement('div'); title.textContent = `${n}-Picture`; title.style.fontWeight='700'; title.style.marginBottom='8px';
  const preview = document.createElement('div'); preview.className='layout-preview';
  preview.style.gridTemplateColumns='1fr';
  preview.style.height=`${n*90}px`;
  preview.innerHTML = Array(n).fill('<div class="layout-cell"></div>').join('');
  t.appendChild(title); t.appendChild(preview);
  t.addEventListener('click', ()=> selectLayout(n,t));
  t.addEventListener('keydown',(e)=>{ if(e.key==='Enter') selectLayout(n,t); });
  return t;
}
LAYOUT_OPTIONS.forEach(n=> layoutsEl.appendChild(createLayoutTile(n)));

function selectLayout(n, el){
  document.querySelectorAll('.layout-tile').forEach(x=>x.classList.remove('selected'));
  el.classList.add('selected'); chosen = n; captures = []; selectedCountEl.textContent = `${n} photos`; seqCountEl.textContent = n; renderCollagePreview();
}

// camera control
async function startCamera(){
  if(cameraStream) return;
  try{ cameraStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false }); camera.srcObject = cameraStream; }
  catch(err){ alert('Unable to access camera. Please allow camera permission in your browser.'); }
}
async function stopCamera(){ if(!cameraStream) return; cameraStream.getTracks().forEach(t=>t.stop()); cameraStream=null; camera.srcObject=null; }

// countdown helper
function startCountdown(seconds, onTick, onEnd){
  clearInterval(countdownTimer);
  let s = seconds;
  countdownEl.textContent = s;
  countdownTimer = setInterval(()=>{
    s--;
    if(s>0){ countdownEl.textContent = s; if(onTick) onTick(s); } 
    else { clearInterval(countdownTimer); countdownEl.textContent=''; if(onEnd) onEnd(); }
  },1000);
}

// capture single frame
function captureOnce(){
  if(!cameraStream) return null;
  const v = camera;
  const canvas = document.createElement('canvas');
  const w = v.videoWidth || 1280;
  const h = v.videoHeight || 720;
  canvas.width=w; canvas.height=h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(v,0,0,canvas.width,canvas.height);
  return canvas.toDataURL('image/png');
}

// sequence capture
async function startSequence(){
  if(!chosen){ alert('Please choose a layout first.'); return; }
  captures = []; renderCollagePreview();
  const secs = parseInt(timerSelect.value,10) || 3;
  for(let i=0;i<chosen;i++){
    await new Promise(resolve=> startCountdown(secs,null,resolve));
    const data = captureOnce();
    if(data) captures.push(data);
    renderCollagePreview();
    await new Promise(r=>setTimeout(r,500));
  }
}

// UI wiring
btnStart.addEventListener('click', async ()=>{ if(!chosen){ alert('Select a layout first.'); return; } await startCamera(); btnCapture.focus(); });
btnCapture.addEventListener('click', ()=>{
  if(!cameraStream){ alert('Camera not started. Press Start.'); return; }
  const secs = parseInt(timerSelect.value,10) || 3;
  startCountdown(secs,null,()=>{
    const d = captureOnce();
    if(d){ captures.push(d); renderCollagePreview(); }
  });
});
btnSequence.addEventListener('click', async ()=>{ if(!cameraStream) await startCamera(); startSequence(); });
window.addEventListener('keydown',(e)=>{ if(e.code==='Space' && document.activeElement.tagName!=='INPUT' && document.activeElement.tagName!=='TEXTAREA'){ e.preventDefault(); btnCapture.click(); } });
btnReset.addEventListener('click', ()=>{ captures=[]; renderCollagePreview(); });

// camera fullscreen
btnFullscreen.addEventListener('click', async ()=>{
  if(!document.fullscreenElement){
    if(cameraContainer.requestFullscreen) await cameraContainer.requestFullscreen();
    else if(camera.requestFullscreen) await camera.requestFullscreen();
  } else { if(document.exitFullscreen) await document.exitFullscreen(); }
});

// download
btnDownload.addEventListener('click', async ()=>{
  if(captures.length===0) return alert('No photos to download.');
  const collage = await buildCollageImage(); 
  const link = document.createElement('a'); 
  link.href = collage; 
  link.download = 'odb_photobooth_collage.png'; 
  link.click();
});

// collage preview
function renderCollagePreview(){
  collagePreview.innerHTML='';
  if(!chosen){ collagePreview.innerHTML='<div style="color:var(--muted);text-align:center">No layout selected</div>'; btnDownload.style.display='none'; previewThumb.style.display='none'; return; }
  collagePreview.style.gridTemplateColumns='1fr';
  for(let i=0;i<chosen;i++){
    const f=document.createElement('div'); f.className='collage-frame'; f.style.minHeight='120px';
    if(captures[i]){
      const img=document.createElement('img');
      img.src=captures[i];
      img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; img.style.borderRadius='6px';
      f.appendChild(img);
    } else {
      f.innerHTML=`<div style="text-align:center;color:var(--muted)">Photo ${i+1}<div style="font-size:0.8rem;color:var(--muted)">Waiting...</div></div>`;
    }
    collagePreview.appendChild(f);
  }
  if(captures.length>0){ previewThumb.src = captures[captures.length-1]; previewThumb.style.display='block'; btnDownload.style.display='inline-block'; } 
  else { previewThumb.style.display='none'; btnDownload.style.display='none'; }
}

// build collage with white border and photostrip name
async function buildCollageImage(){
  const width = 800;
  const heightPerPhoto = 600;
  const border = 30;
  const totalHeight = chosen * (heightPerPhoto + border*2) + 80;
  const canvas = document.createElement('canvas');
  canvas.width = width;
  canvas.height = totalHeight;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  for(let i=0;i<chosen;i++){
    const y = i * (heightPerPhoto + border*2);
    if(captures[i]){
      await drawImageOnCtx(ctx, captures[i], border, y + border, width - border*2, heightPerPhoto);
    } else {
      ctx.fillStyle = '#111';
      ctx.fillRect(border, y + border, width - border*2, heightPerPhoto);
    }
    // Draw white border
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = border;
    ctx.strokeRect(border/2, y + border/2, width - border, heightPerPhoto + border);
  }

  // Draw photobooth name
  ctx.fillStyle = '#000';
  ctx.font = '28px Arial';
  ctx.textAlign = 'center';
  ctx.fillText(PHOTOSTRIP_NAME, width/2, totalHeight - 30);

  return canvas.toDataURL('image/png');
}

// helper to draw image on canvas
function drawImageOnCtx(ctx,src,x,y,w,h){
  return new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=>{ ctx.drawImage(img,x,y,w,h); resolve(); };
    img.onerror = ()=>{ ctx.fillStyle='#111'; ctx.fillRect(x,y,w,h); resolve(); };
    img.src = src;
  });
}

// init
renderCollagePreview();
</script>
</body>
</html>
